<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Classification System</title>
   
</head>
<body>
    <div class="container">
        <h1>Image Classification System</h1>
        <link rel="stylesheet" href="../static/css/indexstyles.css">
        <div class="section">
            <h2>Upload Training Images</h2>
            <input type="text" id="className" placeholder="Enter Class Name (e.g., 'cat', 'dog')">
            <input type="file" id="imageInput" accept="image/*" multiple>
            <br>
            <button onclick="uploadSamples()" id="uploadButton">Upload Samples</button>
            <div id="uploadStatus" class="status"></div>
        </div>

        <div class="section">
            <h2>Train Model</h2>
            <button onclick="trainModel()" id="trainButton">Start Training</button>
            <div id="trainStatus" class="status"></div>
        </div>

        <div class="section">
            <h2>Test Classification</h2>
            <input type="file" id="testImageInput" accept="image/*">
            <br>
            <img id="previewImage">
            <br>
            <button onclick="classifyImage()" id="classifyButton">Classify Image</button>
            <div id="result" class="status"></div>
        </div>
    </div>

    <script>
        function showStatus(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerText = message;
            element.className = 'status ' + (isError ? 'error' : 'success');
        }

        function disableButton(buttonId, disabled = true) {
            const button = document.getElementById(buttonId);
            button.disabled = disabled;
            button.innerText = disabled ? 'Process' : button.innerText.replace('Processing...', button.innerText.split('...')[0]);
        }

        async function uploadSamples() {
            const className = document.getElementById("className").value.trim();
            const files = document.getElementById("imageInput").files;

            if (!className) {
                showStatus("uploadStatus", "Please enter a class name", true);
                return;
            }

            if (files.length === 0) {
                showStatus("uploadStatus", "Please select images to upload", true);
                return;
            }

            disableButton("uploadButton");

            const formData = new FormData();
            formData.append("class_name", className);
            for (let file of files) {
                formData.append("images", file);
            }

            try {
                const response = await fetch("/upload_samples", {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();
                
                if (data.error) {
                    showStatus("uploadStatus", data.error, true);
                } else {
                    showStatus("uploadStatus", data.message);
                    document.getElementById("className").value = "";
                    document.getElementById("imageInput").value = "";
                }
            } catch (error) {
                showStatus("uploadStatus", "Error uploading images: " + error, true);
            } finally {
                disableButton("uploadButton", false);
            }
        }

        async function trainModel() {
            disableButton("trainButton");
            showStatus("trainStatus", "Training in progress...");

            try {
                const response = await fetch("/train", {
                    method: "POST"
                });
                const data = await response.json();
                
                if (data.error) {
                    showStatus("trainStatus", data.error, true);
                } else {
                    showStatus("trainStatus", data.message);
                }
            } catch (error) {
                showStatus("trainStatus", "Error during training: " + error, true);
            } finally {
                disableButton("trainButton", false);
            }
        }

        async function classifyImage() {
            const fileInput = document.getElementById("testImageInput");
            const previewImage = document.getElementById("previewImage");
            const file = fileInput.files[0];

            if (!file) {
                showStatus("result", "Please select an image to classify", true);
                return;
            }

            disableButton("classifyButton");

            // Preview image
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.style.display = "block";
            }
            reader.readAsDataURL(file);

            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch("/classify", {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();
                
                if (data.error) {
                    showStatus("result", data.error, true);
                } else {
                    const result = `Predicted Class: ${data.class} (Confidence: ${(data.confidence * 100).toFixed(2)}%)`;
                    showStatus("result", result);
                }
            } catch (error) {
                showStatus("result", "Error classifying image: " + error, true);
            } finally {
                disableButton("classifyButton", false);
            }
        }

        // Preview image when selected
        document.getElementById("testImageInput").addEventListener("change", function(e) {
            const previewImage = document.getElementById("previewImage");
            const file = e.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.style.display = "block";
                }
                reader.readAsDataURL(file);
            } else {
                previewImage.style.display = "none";
            }
        });
    </script>
</body>
</html>